<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://gltwltqldfoksylzayvs.supabase.co";
  const SUPABASE_KEY = "sb_publishable_cuF14kK1aF-DAduO-r1DPg_CGjpZbuT";
  const EDGE_URL = "https://gltwltqldfoksylzayvs.supabase.co/functions/v1/search-flights";

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false,
    },
  });

  async function getJwt() {
    const { data: sessionData, error: sessionErr } = await supabase.auth.getSession();
    if (sessionErr) throw new Error(sessionErr.message);

    const token1 = sessionData?.session?.access_token;
    if (token1) return token1;

    const { data: anonData, error: anonErr } = await supabase.auth.signInAnonymously();
    if (anonErr) throw new Error(anonErr.message);

    const token2 = anonData?.session?.access_token;
    if (!token2) throw new Error("No JWT returned from anonymous sign in");

    return token2;
  }

  window.searchFlights = async () => {
    const destInput = document.getElementById("destination").value.trim().toUpperCase();
    if (destInput.length !== 3) return alert("×× × ×”×–×Ÿ ×§×•×“ ×™×¢×“ ×ª×§×™×Ÿ (3 ××•×ª×™×•×ª)");

    const btn = document.getElementById("searchBtn");
    const list = document.getElementById("flight-list");

    const payload = {
      region_name: document.getElementById("region").value,
      destination_home: destInput,
      departure_date: document.getElementById("date").value,
      adults: parseInt(document.getElementById("adults").value, 10) || 1,
      children: parseInt(document.getElementById("children").value, 10) || 0,
      infants: parseInt(document.getElementById("infants").value, 10) || 0,
      nonStop: document.getElementById("nonStop").checked,
    };

    if (!payload.departure_date) return alert("×‘×‘×§×©×” ×ª×‘×—×¨ ×ª××¨×™×š ×˜×™×¡×”");

    btn.disabled = true;
    btn.innerHTML = `<span class="animate-pulse tracking-widest italic">SCANNING SKIES...</span>`;
    list.innerHTML =
      `<div class="text-center py-20">
        <div class="animate-spin inline-block w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full mb-4"></div>
        <p class="font-bold text-blue-900 italic">××—×¤×©×™× ×˜×™×¡×•×ª ×‘××§×‘×™×œ ×‘×›×œ ×”××–×•×¨...</p>
      </div>`;

    try {
      const jwt = await getJwt();

      const res = await fetch(EDGE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${jwt}`,
        },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const errorMsg = await res.text();
        throw new Error(`server error: ${res.status} - ${errorMsg}`);
      }

      const data = await res.json();

      if (data && data.length > 0) {
        renderResults(data);
      } else {
        list.innerHTML =
          `<div class="bg-white p-10 rounded-[2rem] text-center shadow font-bold text-slate-400 italic">
            ×œ× × ××¦××• ×˜×™×¡×•×ª ×ª×•×××•×ª. × ×¡×• ×ª××¨×™×š ××• ××–×•×¨ ××—×¨.
          </div>`;
      }
    } catch (e) {
      console.error("Full Error Info:", e);
      alert(e?.message ? e.message : "×©×’×™××ª ×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª. ×‘×“×§×• Network Tab ×‘ F12.");
    } finally {
      btn.disabled = false;
      btn.innerText = "SEARCH FLIGHTS ğŸš€";
    }
  };

  function renderResults(flights) {
    const list = document.getElementById("flight-list");
    list.innerHTML = flights
      .map(
        (f) => `
        <div class="bg-white p-8 rounded-3xl shadow-lg flex flex-col md:flex-row items-center justify-between border-r-[12px] border-blue-600 hover:scale-[1.01] transition-transform duration-300">
          <div class="flex items-center gap-8 text-right">
            <div class="bg-slate-50 p-4 rounded-2xl shadow-inner">
              <img src="https://www.gstatic.com/flights/airline_logos/70px/${f.airline}.png"
                   class="w-16 h-16 object-contain"
                   onerror="this.src='https://via.placeholder.com/64?text=âœˆï¸'">
            </div>
            <div>
              <div class="text-4xl font-black text-slate-800 tracking-tighter">${f.origin_code} <span class="text-blue-500 font-normal">â”</span> ${f.destination_code}</div>
              <div class="text-slate-400 font-bold text-lg mt-1 italic uppercase">${f.departure_date} â€¢ ${f.is_nonstop ? "×˜×™×¡×” ×™×©×™×¨×”" : "×§×•× ×§×©×Ÿ"}</div>
            </div>
          </div>
          <div class="text-center md:text-left mt-6 md:mt-0">
            <div class="text-5xl font-black text-blue-600 leading-none">${f.price} ${f.currency}</div>
            <p class="text-[10px] font-black text-slate-300 tracking-[0.2em] uppercase mt-2 text-center md:text-left">Total for all travelers</p>
          </div>
        </div>
      `,
      )
      .join("");
  }
</script>

