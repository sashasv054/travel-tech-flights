<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://gltwltqldfoksylzayvs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_cuF14kK1aF-DAduO-r1DPg_CGjpZbuT";
  const EDGE_URL = "https://gltwltqldfoksylzayvs.supabase.co/functions/v1/search-flights";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: false,
    },
  });

  async function ensureJwt() {
    const { data: sessionData } = await supabase.auth.getSession();
    if (sessionData?.session?.access_token) return sessionData.session.access_token;

    const { data, error } = await supabase.auth.signInAnonymously();
    if (error) throw new Error(error.message);
    if (!data?.session?.access_token) throw new Error("Failed to obtain access token");
    return data.session.access_token;
  }

  function getInt(id, fallback = 0) {
    const v = Number(document.getElementById(id)?.value ?? fallback);
    return Number.isFinite(v) ? Math.trunc(v) : fallback;
  }

  window.searchFlights = async () => {
    const payload = {
      region_name: String(document.getElementById("region").value || "").trim(),
      destination_home: String(document.getElementById("destination").value || "").trim().toUpperCase(),
      departure_date: String(document.getElementById("date").value || "").trim(),
      adults: Math.max(1, getInt("adults", 1)),
      children: Math.max(0, getInt("children", 0)),
      infants: Math.max(0, getInt("infants", 0)),
      nonStop: Boolean(document.getElementById("nonStop").checked),
    };

    try {
      const accessToken = await ensureJwt();

      const res = await fetch(EDGE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${accessToken}`,
        },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        throw new Error(`Non-JSON response (${res.status}): ${text.slice(0, 300)}`);
      }

      if (!res.ok) {
        const msg = data?.error ? String(data.error) : `Request failed (${res.status})`;
        throw new Error(msg);
      }

      renderResults(data);
    } catch (e) {
      console.error(e);
      alert(e?.message ? e.message : String(e));
    }
  };
</script>

