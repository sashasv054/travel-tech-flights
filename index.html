<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL = "https://gltwltqldfoksylzayvs.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_cuF14kK1aF-DAduO-r1DPg_CGjpZbuT";
  const EDGE_URL = "https://gltwltqldfoksylzayvs.supabase.co/functions/v1/search-flights";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false },
  });

  async function ensureJwt() {
    const { data: s1, error: e1 } = await supabase.auth.getSession();
    if (e1) throw new Error(e1.message);
    if (s1?.session?.access_token) return s1.session.access_token;

    const { data: s2, error: e2 } = await supabase.auth.signInAnonymously();
    if (e2) throw new Error(e2.message);
    if (!s2?.session?.access_token) throw new Error("No access token returned");
    return s2.session.access_token;
  }

  function getEl(id) {
    const el = document.getElementById(id);
    if (!el) throw new Error(`Missing element with id="${id}"`);
    return el;
  }

  function safeRender(data) {
    if (typeof window.renderResults === "function") {
      window.renderResults(data);
      return;
    }
    console.log("renderResults(data):", data);
  }

  function toInt(value, fallback) {
    const n = Number(value);
    return Number.isFinite(n) ? Math.trunc(n) : fallback;
  }

  async function searchFlights() {
    try {
      const payload = {
        region_name: String(getEl("region").value || "").trim(),
        destination_home: String(getEl("destination").value || "").trim().toUpperCase(),
        departure_date: String(getEl("date").value || "").trim(),
        adults: Math.max(1, toInt(getEl("adults").value, 1)),
        children: Math.max(0, toInt(getEl("children").value, 0)),
        infants: Math.max(0, toInt(getEl("infants").value, 0)),
        nonStop: Boolean(getEl("nonStop").checked),
      };

      const jwt = await ensureJwt();

      const res = await fetch(EDGE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_ANON_KEY,
          Authorization: `Bearer ${jwt}`,
        },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        throw new Error(`Edge returned non-JSON (${res.status}): ${text.slice(0, 300)}`);
      }

      if (!res.ok) {
        throw new Error(data?.error ? String(data.error) : `Request failed (${res.status})`);
      }

      safeRender(data);
    } catch (err) {
      console.error("searchFlights error:", err);
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    window.searchFlights = searchFlights;
  });
</script>


