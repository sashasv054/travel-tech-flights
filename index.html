<script type="module">
  (function () {
    const SUPABASE_URL = "https://gltwltqldfoksylzayvs.supabase.co";
    const SUPABASE_KEY = "sb_publishable_cuF14kK1aF-DAduO-r1DPg_CGjpZbuT";
    const EDGE_URL = "https://gltwltqldfoksylzayvs.supabase.co/functions/v1/search-flights";

    const PROJECT_REF = "gltwltqldfoksylzayvs";
    const AUTH_STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

    function showError(err) {
      const msg = err && err.message ? err.message : String(err);
      console.error("FLY SMART error:", err);

      let box = document.getElementById("flysmart-debug");
      if (!box) {
        box = document.createElement("pre");
        box.id = "flysmart-debug";
        box.style.whiteSpace = "pre-wrap";
        box.style.padding = "12px";
        box.style.margin = "12px";
        box.style.background = "#fee2e2";
        box.style.color = "#7f1d1d";
        box.style.borderRadius = "10px";
        box.style.fontSize = "13px";
        box.style.direction = "ltr";
        document.body.prepend(box);
      }
      box.textContent = `JS Error:\n${msg}`;
    }

    window.addEventListener("error", (e) => showError(e.error || e.message));
    window.addEventListener("unhandledrejection", (e) => showError(e.reason));

    function getAccessTokenFromStorage() {
      try {
        const raw = localStorage.getItem(AUTH_STORAGE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && parsed.access_token ? parsed.access_token : null;
      } catch {
        return null;
      }
    }

    async function ensureJwt() {
      const existing = getAccessTokenFromStorage();
      if (existing) return existing;

      const mod = await import("https://esm.sh/@supabase/supabase-js@2");
      const createClient = mod.createClient;

      const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: false,
        },
      });

      const s1 = await supabase.auth.getSession();
      if (s1.error) throw new Error(s1.error.message);
      if (s1.data && s1.data.session && s1.data.session.access_token) {
        return s1.data.session.access_token;
      }

      const s2 = await supabase.auth.signInAnonymously();
      if (s2.error) throw new Error(s2.error.message);
      if (!s2.data || !s2.data.session || !s2.data.session.access_token) {
        throw new Error("Failed to obtain JWT (anonymous sign-in)");
      }
      return s2.data.session.access_token;
    }

    window.searchFlights = async () => {
      try {
        const payload = {
          region_name: document.getElementById("region").value,
          destination_home: document.getElementById("destination").value.toUpperCase(),
          departure_date: document.getElementById("date").value,
          adults: parseInt(document.getElementById("adults").value, 10),
          children: parseInt(document.getElementById("children").value, 10) || 0,
          infants: parseInt(document.getElementById("infants").value, 10) || 0,
          nonStop: document.getElementById("nonStop").checked,
        };

        const jwt = await ensureJwt();

        const res = await fetch(EDGE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${jwt}`,
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(async () => {
          const t = await res.text().catch(() => "");
          throw new Error(`Edge returned non-JSON (${res.status}): ${t.slice(0, 300)}`);
        });

        if (!res.ok) {
          const msg = data && data.error ? String(data.error) : `Request failed (${res.status})`;
          throw new Error(msg);
        }

        if (typeof window.renderResults === "function") {
          window.renderResults(data);
        } else {
          console.log("renderResults is missing. Data:", data);
        }
      } catch (e) {
        showError(e);
      }
    };
  })();
</script>

