<script type="module">
  const SUPABASE_URL = "https://gltwltqldfoksylzayvs.supabase.co";
  const SUPABASE_KEY = "sb_publishable_cuF14kK1aF-DAduO-r1DPg_CGjpZbuT";
  const EDGE_URL = "https://gltwltqldfoksylzayvs.supabase.co/functions/v1/search-flights";

  const PROJECT_REF = "gltwltqldfoksylzayvs";
  const AUTH_STORAGE_KEY = `sb-${PROJECT_REF}-auth-token`;

  function getAccessTokenFromStorage() {
    try {
      const raw = localStorage.getItem(AUTH_STORAGE_KEY);
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      return parsed?.access_token || null;
    } catch {
      return null;
    }
  }

  async function ensureJwt() {
    const existing = getAccessTokenFromStorage();
    if (existing) return existing;

    // Load supabase-js only when the user actually searches (prevents "white page" on load)
    const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: false,
      },
    });

    const { data: s1, error: e1 } = await supabase.auth.getSession();
    if (e1) throw new Error(e1.message);
    if (s1?.session?.access_token) return s1.session.access_token;

    const { data: s2, error: e2 } = await supabase.auth.signInAnonymously();
    if (e2) throw new Error(e2.message);
    if (!s2?.session?.access_token) throw new Error("Failed to obtain JWT");
    return s2.session.access_token;
  }

  window.searchFlights = async () => {
    const payload = {
      region_name: document.getElementById("region").value,
      destination_home: document.getElementById("destination").value.toUpperCase(),
      departure_date: document.getElementById("date").value,
      adults: parseInt(document.getElementById("adults").value, 10),
      children: parseInt(document.getElementById("children").value, 10) || 0,
      infants: parseInt(document.getElementById("infants").value, 10) || 0,
      nonStop: document.getElementById("nonStop").checked,
    };

    try {
      const jwt = await ensureJwt();

      const res = await fetch(EDGE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${jwt}`,
        },
        body: JSON.stringify(payload),
      });

      const data = await res.json();
      renderResults(data);
    } catch (e) {
      console.error(e);
      alert(e?.message ? e.message : String(e));
    }
  };
</script>
